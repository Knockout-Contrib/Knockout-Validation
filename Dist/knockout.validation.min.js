/*=============================================================================
	Author:			Eric M. Barnard - @ericmbarnard								
 Modified:   Sergiy Stotskiy - @stalniy                    
	License:		MIT (http://opensource.org/licenses/mit-license.php)		
																				
	Description:	Validation Library for KnockoutJS							
===============================================================================
*/
!function(a){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?a(require("knockout"),exports):"function"==typeof define&&define.amd?define(["knockout","exports"],a):a(ko,ko.validation={})}(function(a,b){function c(a){var b="max"===a;return function(c,e){if(d.utils.isEmptyVal(c))return!0;var f,g;void 0===e.typeAttr?(g="text",f=e):(g=e.typeAttr,f=e.value),isNaN(f)||(g="number");var h,i,j;switch(g.toLowerCase()){case"week":if(h=/^(\d{4})-W(\d{2})$/,i=c.match(h),null===i)throw"Invalid value for "+a+" attribute for week input.  Should look like '2000-W33' http://www.w3.org/TR/html-markup/input.week.html#input.week.attrs.min";return j=f.match(h),j?b?i[1]<j[1]||i[1]===j[1]&&i[2]<=j[2]:i[1]>j[1]||i[1]===j[1]&&i[2]>=j[2]:!1;case"month":if(h=/^(\d{4})-(\d{2})$/,i=c.match(h),null===i)throw"Invalid value for "+a+" attribute for month input.  Should look like '2000-03' http://www.w3.org/TR/html-markup/input.month.html#input.month.attrs.min";return j=f.match(h),j?b?i[1]<j[1]||i[1]===j[1]&&i[2]<=j[2]:i[1]>j[1]||i[1]===j[1]&&i[2]>=j[2]:!1;case"number":case"range":return b?!isNaN(c)&&parseFloat(c)<=parseFloat(f):!isNaN(c)&&parseFloat(c)>=parseFloat(f);default:return b?f>=c:c>=f}}}if(void 0===typeof a)throw"Knockout is required, please ensure it is loaded before loading this validation plug-in";a.validation=b;var d=a.validation,e=a.utils,f=e.unwrapObservable,g=e.arrayForEach,h=e.extend,i=a.bindingHandlers,j={registerExtenders:!0,messagesOnModified:!0,errorsAsTitle:!0,errorsAsTitleOnModified:!1,messageTemplate:null,insertMessages:!0,parseInputAttributes:!1,writeInputAttributes:!1,decorateInputElement:!1,decorateElementOnModified:!0,errorClass:null,errorElementClass:"validationElement",errorMessageClass:"validationMessage",allowHtmlMessages:!1,grouping:{deep:!1,observable:!0},validate:{}},k=h({},j);k.html5Attributes=["required","pattern","min","max","step"],k.html5InputTypes=["email","number","date"],k.reset=function(){h(k,j)},d.configuration=k,d.utils=function(){var b=(new Date).getTime(),c={},e="__ko_validation__",h={isArray:function(a){return a.isArray||"[object Array]"===Object.prototype.toString.call(a)},isObject:function(a){return null!==a&&"object"==typeof a},getValue:function(a){return"function"==typeof a?a():a},hasAttribute:function(a,b){return null!==a.getAttribute(b)},getAttribute:function(a,b){return a.getAttribute(b)},setAttribute:function(a,b,c){return a.setAttribute(b,c)},isValidatable:function(a){return!!(a&&a.rules&&a.isValid&&a.isModified)},insertAfter:function(a,b){a.parentNode.insertBefore(b,a.nextSibling)},newId:function(){return b+=1},getConfigOptions:function(a){var b,c=a;do b=h.contextFor(c,!0),c=c.parentNode;while(c&&!b);return b||d.configuration},setDomData:function(a,b){var d=a[e];d||(a[e]=d=h.newId()),c[d]=b},getDomData:function(a){var b=a[e];return b?c[b]:void 0},contextFor:function(a,b){switch(a.nodeType){case 1:case 8:var c=h.getDomData(a);if(c)return c;if(!b&&a.parentNode)return h.contextFor(a.parentNode)}return void 0},isEmptyVal:function(a){return void 0===a?!0:null===a?!0:""===a?!0:void 0},getOriginalElementTitle:function(a){var b=h.getAttribute(a,"data-orig-title"),c=a.title,d=h.hasAttribute(a,"data-orig-title");return d?b:c},async:function(a){window.setImmediate?window.setImmediate(a):window.setTimeout(a,0)},forEach:function(a,b){if(h.isArray(a))return g(a,b);for(var c in a)a.hasOwnProperty(c)&&b(a[c],c)},observablesOf:function(b,c,d,e){var g=[];if(b.__kv_traversed===!0)return g;if(d.deep&&(d.flagged||(d.flagged=[]),b.__kv_traversed=!0,d.flagged.push(b)),"undefined"==typeof e&&(e=d.deep?1:-1),a.isObservable(b)&&c(b,g),0!==e){var i,j=f(b);i=j&&(h.isArray(j)||h.isObject(j))?j:[],h.forEach(i,function(a){a&&!a.nodeType&&g.push.apply(g,h.observablesOf(a,c,d,e+1))})}if(1===e&&d.deep){for(var k=d.flagged.length;k--;)delete d.flagged[k].__kv_traversed;d.flagged.length=0,delete d.flagged}return g}};return h}();var l=function(){function b(a){var b=[];return g(a,function(a){a.isValid()||b.push(a.error)}),b}function c(a,b){l.isValidatable(a)||a.extend({validatable:!0}),b.push(a)}var j=0,k=d.configuration,l=d.utils;return{init:function(a,b){j>0&&!b||(a=a||{},a.errorElementClass=a.errorElementClass||a.errorClass||k.errorElementClass,a.errorMessageClass=a.errorMessageClass||a.errorClass||k.errorMessageClass,h(k,a),k.registerExtenders&&d.registerExtenders(),j=1)},configure:function(a){d.init(a)},reset:d.configuration.reset,model:function(d,f){f=h(h({},k.grouping),f);var i,j,m=l.observablesOf(d,c,f),n=function(){return b(m)};return f.observable?(i=a.computed(n),i.throttleEvaluation=10,j=a.observable(0===i().length),i.subscribe(function(a){j(0===a.length)})):(i=n,j=function(){return 0===i().length}),n=null,h({isValid:j,errors:i,markAsModified:function(a){var b=0===arguments.length||a;g(m,function(a){a.isModified(b)})},isAnyInvalidModified:function(){return!!e.arrayFirst(m,function(a){return!a.isValid()&&a.isModified()})}},d)},formatMessage:function(a,b){return"function"==typeof a?a(b):a.replace(/\{0\}/gi,f(b))},addRule:function(a,b){return a.extend({validatable:!0}),a.rules.push(b),a},addAnonymousRule:function(a,b){void 0===b.message&&(b.message="Error"),d.addRule(a,b)},addExtender:function(b){a.extenders[b]=function(a,c){return c&&(c.message||c.onlyIf)?d.addRule(a,{rule:b,message:c.message,params:l.isEmptyVal(c.params)?!0:c.params,condition:c.onlyIf}):d.addRule(a,{rule:b,params:c})}},registerExtenders:function(){if(k.registerExtenders)for(var b in d.rules)d.rules.hasOwnProperty(b)&&(a.extenders[b]||d.addExtender(b))},insertValidationMessage:function(a){var b=document.createElement("SPAN");return b.className=l.getConfigOptions(a).errorMessageClass,l.insertAfter(a,b),b},parseInputValidationAttributes:function(a,b){g(d.configuration.html5Attributes,function(c){if(l.hasAttribute(a,c)){var e=a.getAttribute(c)||!0;if("min"===c||"max"===c){var f=a.getAttribute("type");"undefined"!=typeof f&&f||(f="text"),e={typeAttr:f,value:e}}d.addRule(b(),{rule:c,params:e})}});var c=a.getAttribute("type");g(d.configuration.html5InputTypes,function(a){a===c&&d.addRule(b(),{rule:"date"===a?"dateISO":a,params:!0})})},writeInputValidationAttributes:function(a,b){var c=b();if(c&&c.rules){var f=c.rules();g(d.configuration.html5Attributes,function(b){var c,d=e.arrayFirst(f,function(a){return a.rule.toLowerCase()===b.toLowerCase()});d&&(c=d.params,"pattern"===d.rule&&d.params instanceof RegExp&&(c=d.params.source),a.setAttribute(b,c))}),f=null}},makeBindingHandlerValidatable:function(b){var c=a.bindingHandlers[b].init;a.bindingHandlers[b].init=function(a,b,d,e,f){return c(a,b,d,e,f),i.exposeValidationResult.init(a,b,d,e,f)}},setRules:function(b,c){var e=function(b,c){if(b&&c)for(var g in c)if(c.hasOwnProperty(g)){var h=c[g];if(b[g]){var i=b[g],j=f(i),k={},m={};for(var n in h)h.hasOwnProperty(n)&&(d.rules[n]?k[n]=h[n]:m[n]=h[n]);if(a.isObservable(i)&&i.extend(k),j&&l.isArray(j))for(var o=0;o<j.length;o++)e(j[o],m);else e(j,m)}}};e(b,c)}}}();h(a.validation,l),d.rules={},d.rules.required={validator:function(a,b){var c,d=/^\s+|\s+$/g;return void 0===a||null===a?!b:(c=a,"string"==typeof a&&(c=a.replace(d,"")),b?(c+"").length>0:!0)},message:"This field is required."},d.rules.min={validator:c("min"),message:"Please enter a value greater than or equal to {0}."},d.rules.max={validator:c("max"),message:"Please enter a value less than or equal to {0}."},d.rules.minLength={validator:function(a,b){return d.utils.isEmptyVal(a)||a.length>=b},message:"Please enter at least {0} characters."},d.rules.maxLength={validator:function(a,b){return d.utils.isEmptyVal(a)||a.length<=b},message:"Please enter no more than {0} characters."},d.rules.pattern={validator:function(a,b){return d.utils.isEmptyVal(a)||null!==a.toString().match(b)},message:"Please check this value."},d.rules.step={validator:function(a,b){if(d.utils.isEmptyVal(a)||"any"===b)return!0;var c=100*a%(100*b);return Math.abs(c)<1e-5||Math.abs(1-c)<1e-5},message:"The value must increment by {0}"},d.rules.email={validator:function(a,b){return b?d.utils.isEmptyVal(a)||b&&/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i.test(a):!0},message:"Please enter a proper email address"},d.rules.date={validator:function(a,b){return b?d.utils.isEmptyVal(a)||b&&!/Invalid|NaN/.test(new Date(a)):!0},message:"Please enter a proper date"},d.rules.dateISO={validator:function(a,b){return b?d.utils.isEmptyVal(a)||b&&/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/.test(a):!0},message:"Please enter a proper date"},d.rules.number={validator:function(a,b){return b?d.utils.isEmptyVal(a)||b&&/^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/.test(a):!0},message:"Please enter a number"},d.rules.digit={validator:function(a,b){return b?d.utils.isEmptyVal(a)||b&&/^\d+$/.test(a):!0},message:"Please enter a digit"},d.rules.phoneUS={validator:function(a,b){return b?d.utils.isEmptyVal(a)?!0:"string"!=typeof a?!1:(a=a.replace(/\s+/g,""),b&&a.length>9&&a.match(/^(1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/)):!0},message:"Please specify a valid phone number"},d.rules.equal={validator:function(a,b){var c=b;return a===d.utils.getValue(c)},message:"Values must equal"},d.rules.notEqual={validator:function(a,b){var c=b;return a!==d.utils.getValue(c)},message:"Please choose another value."},d.rules.unique={validator:function(a,b){var c=d.utils.getValue(b.collection),f=d.utils.getValue(b.externalValue),g=0;return a&&c?(e.arrayFilter(c,function(c){a===(b.valueAccessor?b.valueAccessor(c):c)&&g++}),(f?1:2)>g):!0},message:"Please make sure the value is unique."},function(){d.registerExtenders()}(),i.exposeValidationResult=function(){return{init:function(b,c){var e=d.utils.getConfigOptions(b),f=c();if(e.parseInputAttributes&&d.utils.async(function(){d.parseInputValidationAttributes(b,c)}),!d.utils.isValidatable(f))return!1;if(e.insertMessages){var g=d.insertValidationMessage(b);e.messageTemplate?a.renderTemplate(e.messageTemplate,{field:f},null,g,"replaceNode"):a.applyBindingsToNode(g,{validationMessage:f})}e.writeInputAttributes&&d.writeInputValidationAttributes(b,c),e.decorateInputElement&&a.applyBindingsToNode(b,{validationStyle:f})}}}(),d.makeBindingHandlerValidatable("value"),d.makeBindingHandlerValidatable("checked"),i.validationMessage={update:function(b,c){var e=c();if(!d.utils.isValidatable(e))throw new Error("Observable is not validatable");var f=d.utils.getConfigOptions(b),g=e.isModified(),h=e.error.isEmpty(),i=null,j=!1;(!f.messagesOnModified||g)&&(i=h?null:e.error(),j=!h);var k=f.allowHtmlMessages?"html":"text";a.bindingHandlers[k].update(b,function(){return i});var l="none"!==b.style.display;l&&!j?b.style.display="none":!l&&j&&(b.style.display="")}},i.validationStyle={update:function(a,b){var c=b();if(!d.utils.isValidatable(c))throw new Error("Observable is not validatable");var e=d.utils.getConfigOptions(a),f=c.isModified(),g=c.error.isEmpty();i.css.update(a,function(){var a={};return a[e.errorElementClass]=!e.decorateElementOnModified||f?!g:!1,a}),e.errorsAsTitle&&i.validationStyle.setErrorAsTitleOn(a,c,e)},setErrorAsTitleOn:function(a,b,c){var e=b.error.isEmpty(),f=b.isModified();i.attr.update(a,function(){var g=d.utils.getOriginalElementTitle(a),h=!c.errorsAsTitleOnModified||f;return h&&!e?{title:b.error,"data-orig-title":g}:!h||e?{title:g,"data-orig-title":null}:void 0})}},i.validationOptions={init:function(a,b){var c=f(b());if(c){var e=h({},d.configuration);h(e,c),d.utils.setDomData(a,e)}}},function(){function b(){this.target.isModified(!0)}function c(){this(null)}function e(){return null===this()}function h(a,b,c){var e=f("undefined"==typeof c.params?!0:c.params);return b.validator(a(),e)?!0:(a.error(d.formatMessage(c.message||b.message,e)),!1)}function i(a,b,c){var e=f(c.params||!0);a.isValidating(!0),b.validator(a(),e,function(f){if(a.isValid()){var g,h=f;d.utils.isObject(f)&&(h=f.isValid,g=f.message||""),h||a.error(d.formatMessage(g||c.message||b.message,e))}a.isValidating(!1)})}a.extenders.validation=function(a,b){return g(d.utils.isArray(b)?b:[b],function(b){d.addAnonymousRule(a,b)}),a},a.extenders.validatable=function(f,g){if(d.utils.isObject(g)||(g={enable:g}),"enable"in g||(g.enable=!0),g.enable&&!d.utils.isValidatable(f)){f.error=a.observable(null),f.error.clear=c,f.error.isEmpty=e,f.rules=a.observableArray(),f.isValidating=a.observable(!1),f.isModified=a.observable(!1),f.isValid=a.observable(!0),f.error.subscribe(function(){f.isValid(f.error.isEmpty())});var h=f.subscribe(b),i=a.computed(function(){f(),d.process(f)}),j=d.configuration.validate;i.throttleEvaluation=g.throttle||j&&j.throttle,f._disposeValidation=function(){this.rules.removeAll(),h.dispose(),i.dispose(),delete this.rules,delete this.error,delete this.isValid,delete this.isValidating,delete this.isModified}}else g.enable===!1&&f._disposeValidation&&f._disposeValidation();return f},d.process=function(a){for(var b,c,e=a.rules(),f=0,g=e.length;g>f;f++)if(c=e[f],!c.condition||c.condition())if(b=c.rule?d.rules[c.rule]:c,b.async||c.async)i(a,b,c);else if(!h(a,b,c))return!1;return a.error.clear(),!0}}(),d.localize=function(a){var b;for(b in a)d.rules.hasOwnProperty(b)&&(d.rules[b].message=a[b])},a.applyBindingsWithValidation=function(b,c,e){var f,g,h=arguments.length;h>2?(f=c,g=e):2>h?f=document.body:arguments[1].nodeType?f=c:g=arguments[1],d.init(),g&&d.utils.setDomData(f,g),a.applyBindings(b,c)};var m=a.applyBindings;a.applyBindings=function(a,b){d.init(),m(a,b)},a.validatedObservable=function(b){return a.observable(b).extend({validatable:!0})}});