/*
===============================================================================
    Author:     Eric M. Barnard - @ericmbarnard                                
    License:    MIT (http://opensource.org/licenses/mit-license.php)           
                                                                               
    Description: Validation Library for KnockoutJS                             
===============================================================================
*/
(function(a){typeof require=="function"&&typeof exports=="object"&&typeof module=="object"?a(require("knockout"),exports):typeof define=="function"&&define.amd?define(["knockout","exports"],a):a(ko,ko.validation={})})(function(a,b){function i(b,c,d){return c.validator(b(),d.params===undefined?!0:d.params)?!0:(b.error=a.validation.formatMessage(d.message||c.message,d.params),b.__valid__(!1),!1)}function j(b,c,d){b.isValidating(!0);var e=function(e){var f=!1,g="";if(!b.__valid__()){b.isValidating(!1);return}e.message?(f=e.isValid,g=e.message):f=e,f||(b.error=a.validation.formatMessage(g||d.message||c.message,d.params),b.__valid__(f)),b.isValidating(!1)};c.validator(b(),d.params||!0,e)}if(typeof a===undefined)throw"Knockout is required, please ensure it is loaded before loading this validation plug-in";var c={registerExtenders:!0,messagesOnModified:!0,messageTemplate:null,insertMessages:!0,parseInputAttributes:!1,writeInputAttributes:!1,decorateElement:!1,errorClass:null,errorElementClass:"validationElement",errorMessageClass:"validationMessage",grouping:{deep:!1,observable:!0}},d=a.utils.extend({},c),e=["required","pattern","min","max","step"],f=function(a){window.setImmediate?window.setImmediate(a):window.setTimeout(a,0)},g=function(){var a=(new Date).getTime(),b={},c="__ko_validation__";return{isArray:function(a){return a.isArray||Object.prototype.toString.call(a)==="[object Array]"},isObject:function(a){return a!==null&&typeof a=="object"},values:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},getValue:function(a){return typeof a=="function"?a():a},hasAttribute:function(a,b){return a.getAttribute(b)!==null},isValidatable:function(a){return a&&a.rules&&a.isValid&&a.isModified},insertAfter:function(a,b){a.parentNode.insertBefore(b,a.nextSibling)},newId:function(){return a+=1},getConfigOptions:function(a){var b=g.contextFor(a);return b||d},setDomData:function(a,d){var e=a[c];e||(a[c]=e=g.newId()),b[e]=d},getDomData:function(a){var d=a[c];return d?b[d]:undefined},contextFor:function(a){switch(a.nodeType){case 1:case 8:var b=g.getDomData(a);if(b)return b;if(a.parentNode)return g.contextFor(a.parentNode)}return undefined},isEmptyVal:function(a){if(a===undefined)return!0;if(a===null)return!0;if(a==="")return!0}}}(),h=function(){var b=0;return{utils:g,init:function(c,e){if(b>0&&!e)return;c=c||{},c.errorElementClass=c.errorElementClass||c.errorClass||d.errorElementClass,c.errorMessageClass=c.errorMessageClass||c.errorClass||d.errorMessageClass,a.utils.extend(d,c),d.registerExtenders&&a.validation.registerExtenders(),b=1},configure:function(b){a.validation.init(b)},reset:function(){d=$.extend(d,c)},group:function f(b,c){var c=a.utils.extend(d.grouping,c),e=a.observableArray([]),f=null,h=function i(b,d){var f=[],h=a.utils.unwrapObservable(b);d=d!==undefined?d:c.deep?1:-1,a.isObservable(b)&&(b.isValid||b.extend({validatable:!0}),e.push(b)),h&&(g.isArray(h)?f=h:g.isObject(h)&&(f=g.values(h))),d!==0&&a.utils.arrayForEach(f,function(a){a&&!a.nodeType&&i(a,d+1)})};return c.observable?(h(b),f=a.computed(function(){var b=[];return a.utils.arrayForEach(e(),function(a){a.isValid()||b.push(a.error)}),b})):f=function(){var c=[];return e([]),h(b),a.utils.arrayForEach(e(),function(a){a.isValid()||c.push(a.error)}),c},f.showAllMessages=function(b){b==undefined&&(b=!0),f(),a.utils.arrayForEach(e(),function(a){a.isModified(b)})},b.errors=f,b.isValid=function(){return b.errors().length===0},b.isAnyMessageShown=function(){var b=!1;return f(),a.utils.arrayForEach(e(),function(a){!a.isValid()&&a.isModified()&&(b=!0)}),b},f},formatMessage:function(a,b){return typeof a=="function"?a(b):a.replace(/\{0\}/gi,b)},addRule:function(a,b){return a.extend({validatable:!0}),a.rules.push(b),a},addAnonymousRule:function(b,c){var d=g.newId();c.message===undefined&&(c.message="Error"),a.validation.rules[d]=c,a.validation.addRule(b,{rule:d,params:c.params})},addExtender:function(b){a.extenders[b]=function(c,d){return d.message||d.onlyIf?a.validation.addRule(c,{rule:b,message:d.message,params:g.isEmptyVal(d.params)?!0:d.params,condition:d.onlyIf}):a.validation.addRule(c,{rule:b,params:d})}},registerExtenders:function(){if(d.registerExtenders)for(var b in a.validation.rules)a.validation.rules.hasOwnProperty(b)&&(a.extenders[b]||a.validation.addExtender(b))},insertValidationMessage:function(a){var b=document.createElement("SPAN");return b.className=g.getConfigOptions(a).errorMessageClass,g.insertAfter(a,b),b},parseInputValidationAttributes:function(b,c){a.utils.arrayForEach(e,function(d){g.hasAttribute(b,d)&&a.validation.addRule(c(),{rule:d,params:b.getAttribute(d)||!0})})},writeInputValidationAttributes:function(b,c){var d=c();if(!d||!d.rules)return;var f=d.rules();a.utils.arrayForEach(e,function(c){var d,e=a.utils.arrayFirst(f,function(a){return a.rule.toLowerCase()===c.toLowerCase()});if(!e)return;d=e.params,e.rule=="pattern"&&e.params instanceof RegExp&&(d=e.params.source),b.setAttribute(c,d)}),f=null}}}();h.rules={},h.rules.required={validator:function(a,b){var c=/^\s+|\s+$/g,d;return a===undefined||a===null?!b:(d=a,typeof a=="string"&&(d=a.replace(c,"")),b?(d+"").length>0:!0)},message:"This field is required."},h.rules.min={validator:function(a,b){return g.isEmptyVal(a)||a>=b},message:"Please enter a value greater than or equal to {0}."},h.rules.max={validator:function(a,b){return g.isEmptyVal(a)||a<=b},message:"Please enter a value less than or equal to {0}."},h.rules.minLength={validator:function(a,b){return g.isEmptyVal(a)||a.length>=b},message:"Please enter at least {0} characters."},h.rules.maxLength={validator:function(a,b){return g.isEmptyVal(a)||a.length<=b},message:"Please enter no more than {0} characters."},h.rules.pattern={validator:function(a,b){return g.isEmptyVal(a)||a.match(b)!=null},message:"Please check this value."},h.rules.step={validator:function(a,b){return g.isEmptyVal(a)||a*100%(b*100)===0},message:"The value must increment by {0}"},h.rules.email={validator:function(a,b){return b?g.isEmptyVal(a)||b&&/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i.test(a):!0},message:"Please enter a proper email address"},h.rules.date={validator:function(a,b){return b?g.isEmptyVal(a)||b&&!/Invalid|NaN/.test(new Date(a)):!0},message:"Please enter a proper date"},h.rules.dateISO={validator:function(a,b){return b?g.isEmptyVal(a)||b&&/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(a):!0},message:"Please enter a proper date"},h.rules.number={validator:function(a,b){return b?g.isEmptyVal(a)||b&&/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test(a):!0},message:"Please enter a number"},h.rules.digit={validator:function(a,b){return b?g.isEmptyVal(a)||b&&/^\d+$/.test(a):!0},message:"Please enter a digit"},h.rules.phoneUS={validator:function(a,b){return b?typeof a!="string"?!1:g.isEmptyVal(a)?!0:(a=a.replace(/\s+/g,""),b&&a.length>9&&a.match(/^(1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/)):!0},message:"Please specify a valid phone number"},h.rules.equal={validator:function(a,b){var c=b;return a===g.getValue(c)},message:"Values must equal"},h.rules.notEqual={validator:function(a,b){var c=b;return a!==g.getValue(c)},message:"Please choose another value."},h.rules.unique={validator:function(b,c){var d=g.getValue(c.collection),e=g.getValue(c.externalValue),f=0;return!b||!d?!0:(a.utils.arrayFilter(a.utils.unwrapObservable(d),function(a){b===(c.valueAccessor?c.valueAccessor(a):a)&&f++}),f<(e!==undefined&&b!==e?1:2))},message:"Please make sure the value is unique."},function(){h.registerExtenders()}(),a.bindingHandlers.validationCore=function(){return{init:function(b,c,d,e,h){var i=g.getConfigOptions(b);i.parseInputAttributes&&f(function(){a.validation.parseInputValidationAttributes(b,c)});if(i.insertMessages&&g.isValidatable(c())){var j=a.validation.insertValidationMessage(b);i.messageTemplate?a.renderTemplate(i.messageTemplate,{field:c()},null,j,"replaceNode"):a.applyBindingsToNode(j,{validationMessage:c()})}i.writeInputAttributes&&g.isValidatable(c())&&a.validation.writeInputValidationAttributes(b,c),i.decorateElement&&g.isValidatable(c())&&a.applyBindingsToNode(b,{validationElement:c()})},update:function(a,b,c,d,e){}}}(),function(){var b=a.bindingHandlers.value.init;a.bindingHandlers.value.init=function(c,d,e,f,g){return b(c,d,e),a.bindingHandlers.validationCore.init(c,d,e,f,g)}}(),a.bindingHandlers.validationMessage={update:function(b,c){var d=c(),e=g.getConfigOptions(b),f=a.utils.unwrapObservable(d),h=null,i=!1,j=!1;d.extend({validatable:!0}),i=d.isModified(),j=d.isValid();var k=function(){return!e.messagesOnModified||i?j?null:d.error:null},l=function(){return i?!j:!1};a.bindingHandlers.text.update(b,k),a.bindingHandlers.visible.update(b,l)}},a.bindingHandlers.validationElement={update:function(b,c){var d=c(),e=g.getConfigOptions(b),f=a.utils.unwrapObservable(d),h=null,i=!1,j=!1;d.extend({validatable:!0}),i=d.isModified(),j=d.isValid();var k=function(){var a={},b=i?!j:!1;return e.decorateElement||(b=!1),a[e.errorElementClass]=b,a};a.bindingHandlers.css.update(b,k)}},a.bindingHandlers.validationOptions=function(){return{init:function(b,c,e,f,h){var i=a.utils.unwrapObservable(c());if(i){var j=a.utils.extend({},d);a.utils.extend(j,i),g.setDomData(b,j)}}}}(),a.extenders.validation=function(b,c){return a.utils.arrayForEach(g.isArray(c)?c:[c],function(c){a.validation.addAnonymousRule(b,c)}),b},a.extenders.validatable=function(b,c){if(c&&!g.isValidatable(b)){b.error=null,b.rules=a.observableArray(),b.isValidating=a.observable(!1),b.__valid__=a.observable(!0),b.isModified=a.observable(!1);var d=a.computed(function(){var c=b(),d=b.rules();return a.validation.validateObservable(b),!0});b.isValid=a.computed(function(){return b.__valid__()});var e=b.subscribe(function(){b.isModified(!0)});b._disposeValidation=function(){b.isValid.dispose(),b.rules.removeAll(),b.isModified._subscriptions.change=[],b.isValidating._subscriptions.change=[],b.__valid__._subscriptions.change=[],e.dispose(),d.dispose(),delete b.rules,delete b.error,delete b.isValid,delete b.isValidating,delete b.__valid__,delete b.isModified}}else c===!1&&g.isValidatable(b)&&b._disposeValidation&&b._disposeValidation();return b},h.validateObservable=function(b){var c=0,d,e,f=b.rules(),g=f.length;for(;c<g;c++){e=f[c];if(e.condition&&!e.condition())continue;d=a.validation.rules[e.rule];if(d.async||e.async)j(b,d,e);else if(!i(b,d,e))return!1}return b.error=null,b.__valid__(!0),!0},a.validatedObservable=function(b){if(!a.validation.utils.isObject(b))return a.observable(b).extend({validatable:!0});var c=a.observable(b);return c.errors=a.validation.group(b),c.isValid=a.computed(function(){return c.errors().length===0}),c},h.localize=function(b){var c,d;for(d in b)a.validation.rules.hasOwnProperty(d)&&(a.validation.rules[d].message=b[d])},a.applyBindingsWithValidation=function(b,c,d){var e=arguments.length,f,g;e>2?(f=c,g=d):e<2?f=document.body:arguments[1].nodeType?f=c:g=arguments[1],a.validation.init(),g&&a.validation.utils.setDomData(f,g),a.applyBindings(b,c)};var k=a.applyBindings;a.applyBindings=function(b,c){a.validation.init(),k(b,c)},a.utils.extend(b,h)});